# ===========================================
# Meeting Assistant - Docker Compose (Production)
# ===========================================
# Usage:
#   Build:  docker compose -f docker-compose.prod.yml build
#   Deploy: docker compose -f docker-compose.prod.yml up -d
#
# IMPORTANT: Requires .env.production file with all secrets configured
# ===========================================

services:
  # -------------------------------------------
  # Redis (Message Queue & Cache)
  # -------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: rkj-redis
    restart: always
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - rkj-ai
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  # -------------------------------------------
  # Web Frontend (Next.js 16)
  # -------------------------------------------
  web:
    build:
      context: ../../apps/web
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
        - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
        - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
        - NEXT_PUBLIC_R2_URL=${R2_PUBLIC_URL}
    image: rkj-web:latest
    container_name: rkj-web
    restart: always
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
      - NEXT_PUBLIC_R2_URL=${R2_PUBLIC_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - ORCHESTRATOR_URL=http://bot-orchestrator:8002
    depends_on:
      redis:
        condition: service_healthy
      bot-orchestrator:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:3000" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - rkj-ai
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # -------------------------------------------
  # Backend API (FastAPI)
  # -------------------------------------------
  api:
    build:
      context: ../../apps/api
      dockerfile: Dockerfile
    image: rkj-api:latest
    container_name: rkj-api
    restart: always
    ports:
      - "8000:8000"
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - REDIS_URL=redis://redis:6379
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - rkj-ai
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # -------------------------------------------
  # Scheduler (Calendar Sync & Meeting Detection)
  # -------------------------------------------
  scheduler:
    build:
      context: ../../services/scheduler
      dockerfile: Dockerfile
    image: rkj-scheduler:latest
    container_name: rkj-scheduler
    restart: always
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - REDIS_URL=redis://redis:6379
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - BOT_JOIN_BEFORE_MINUTES=${BOT_JOIN_BEFORE_MINUTES:-2}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - rkj-ai
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # -------------------------------------------
  # Bot Orchestrator (Container Management)
  # -------------------------------------------
  bot-orchestrator:
    build:
      context: ../../services/bot-orchestrator
      dockerfile: Dockerfile
    image: rkj-bot-orchestrator:latest
    container_name: rkj-bot-orchestrator
    restart: always
    ports:
      - "8002:8002"
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - REDIS_URL=redis://redis:6379
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL}
      - BOT_DISPLAY_NAME=${BOT_DISPLAY_NAME:-Meeting Assistant Bot ðŸ¤–}
      - BOT_MAX_DURATION_HOURS=${BOT_MAX_DURATION_HOURS:-4}
      - BOT_IMAGE=rkj-meet-bot:latest
      - DOCKER_NETWORK=rkj-ai-network
      - RECORDINGS_VOLUME=docker_recordings
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      # Docker socket for spawning bot containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Shared recordings volume
      - recordings:/recordings
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8002/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - rkj-ai
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

  # -------------------------------------------
  # Meet Bot (Build only - spawned by orchestrator)
  # -------------------------------------------
  # IMPORTANT: This service is NOT started directly.
  # The image is built here and spawned dynamically
  # by the bot-orchestrator when meetings start.
  meet-bot:
    build:
      context: ../../services/meet-bot
      dockerfile: Dockerfile
    image: rkj-meet-bot:latest
    profiles:
      - build-only

  # -------------------------------------------
  # Transcription Worker
  # -------------------------------------------
  transcription-worker:
    build:
      context: ../../services/transcription-worker
      dockerfile: Dockerfile
    image: rkj-transcription-worker:latest
    container_name: rkj-transcription-worker
    restart: always
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - REDIS_URL=redis://redis:6379
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_WHISPER_MODEL=${OPENAI_WHISPER_MODEL:-whisper-1}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - recordings:/recordings:ro
      - temp_audio:/tmp/audio
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - rkj-ai
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# -------------------------------------------
# Volumes
# -------------------------------------------
volumes:
  redis_data:
    driver: local
  recordings:
    driver: local
  temp_audio:
    driver: local

# -------------------------------------------
# Networks
# -------------------------------------------
networks:
  rkj-ai:
    driver: bridge
    name: rkj-ai-network
