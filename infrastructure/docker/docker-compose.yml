# ===========================================
# Meeting Assistant - Docker Compose (Development)
# ===========================================
# Usage: docker-compose up -d

version: '3.8'

services:
  # -------------------------------------------
  # Redis (Message Queue & Cache)
  # -------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: rkj-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - rkj-ai

  # -------------------------------------------
  # Web Frontend (Next.js 16)
  # -------------------------------------------
  # IMPORTANT: NEXT_PUBLIC_* variables are embedded in the JS bundle and accessed by the BROWSER.
  # The browser CANNOT resolve host.docker.internal - it must use localhost.
  # Server-side code inside the container can use host.docker.internal via SUPABASE_URL.
  web:
    build:
      context: ../../apps/web
      dockerfile: Dockerfile
      args:
        # CRITICAL: Use localhost for browser-facing URLs (NOT host.docker.internal)
        - NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
        - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0}
        - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
        - NEXT_PUBLIC_R2_URL=${R2_PUBLIC_URL}
    container_name: rkj-web
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # CRITICAL: Use localhost for browser-facing URLs (NOT host.docker.internal)
      - NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      - NEXT_PUBLIC_R2_URL=${R2_PUBLIC_URL}
      # Server-side URL for internal container communication
      - SUPABASE_URL=${SUPABASE_URL:-http://host.docker.internal:54321}
      - ORCHESTRATOR_URL=http://bot-orchestrator:8002
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:3000" ]
      interval: 30s
      timeout: 10s
      retries: 3
    extra_hosts:
      # Allow the container to resolve localhost to the host machine
      # This enables using the same Supabase URL for both browser and server (required for PKCE cookies)
      - "localhost:host-gateway"
    networks:
      - rkj-ai

  # -------------------------------------------
  # Backend API (FastAPI)
  # -------------------------------------------
  api:
    build:
      context: ../../apps/api
      dockerfile: Dockerfile
    container_name: rkj-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - REDIS_URL=redis://redis:6379
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ../../apps/api/src:/app/src:ro
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - rkj-ai

  # -------------------------------------------
  # Scheduler (Calendar Sync & Meeting Detection)
  # -------------------------------------------
  scheduler:
    build:
      context: ../../services/scheduler
      dockerfile: Dockerfile
    container_name: rkj-scheduler
    restart: unless-stopped
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - REDIS_URL=redis://redis:6379
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - BOT_JOIN_BEFORE_MINUTES=${BOT_JOIN_BEFORE_MINUTES:-2}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ../../services/scheduler/src:/app/src:ro
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - rkj-ai
  # -------------------------------------------
  # Bot Orchestrator (Container Management)
  # -------------------------------------------
  bot-orchestrator:
    build:
      context: ../../services/bot-orchestrator
      dockerfile: Dockerfile
    container_name: rkj-bot-orchestrator
    restart: unless-stopped
    ports:
      - "8002:8002"
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - REDIS_URL=redis://redis:6379
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL}
      - BOT_DISPLAY_NAME=${BOT_DISPLAY_NAME:-RKJ.AI}
      - BOT_MAX_DURATION_HOURS=${BOT_MAX_DURATION_HOURS:-4}
      - BOT_IMAGE=docker-meet-bot:latest
      - DOCKER_NETWORK=rkj-ai-network
      - RECORDINGS_VOLUME=docker_recordings
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - GOOGLE_AUTH_LOGIN=${GOOGLE_AUTH_LOGIN}
      - GOOGLE_AUTH_PASSWORD=${GOOGLE_AUTH_PASSWORD}
    volumes:
      # Docker socket for spawning bot containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Shared recordings volume
      - recordings:/recordings
      - ../../services/bot-orchestrator/src:/app/src:ro
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - rkj-ai

  # -------------------------------------------
  # Meet Bot (Build only - spawned by orchestrator)
  # -------------------------------------------
  meet-bot:
    build:
      context: ../../services/meet-bot
      dockerfile: Dockerfile
    image: docker-meet-bot:latest
    # This service is not started directly
    # It's spawned by the bot-orchestrator when needed
    profiles:
      - build-only

  # -------------------------------------------
  # Transcription Worker
  # -------------------------------------------
  transcription-worker:
    build:
      context: ../../services/transcription-worker
      dockerfile: Dockerfile
    container_name: rkj-transcription-worker
    restart: unless-stopped
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - REDIS_URL=redis://redis:6379
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_WHISPER_MODEL=${OPENAI_WHISPER_MODEL:-whisper-1}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - recordings:/recordings:ro
      - temp_audio:/tmp/audio
      - ../../services/transcription-worker/src:/app/src:ro
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - rkj-ai

  # -------------------------------------------
  # Media Processor (Video/Audio Processing)
  # TODO: Uncomment when services/media-processor is created
  # -------------------------------------------
  # media-processor:
  #   build:
  #     context: ../../services/media-processor
  #     dockerfile: Dockerfile
  #   container_name: ma-media-processor
  #   restart: unless-stopped
  #   environment:
  #     - SUPABASE_URL=${SUPABASE_URL}
  #     - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
  #     - REDIS_URL=redis://redis:6379
  #     - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
  #     - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
  #     - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
  #     - R2_BUCKET_NAME=${R2_BUCKET_NAME}
  #     - LOG_LEVEL=${LOG_LEVEL:-INFO}
  #   volumes:
  #     - recordings:/recordings
  #     - temp_media:/tmp/media
  #     - ../../services/media-processor/src:/app/src:ro
  #   depends_on:
  #     redis:
  #       condition: service_healthy
  #   networks:
  #     - meeting-assistant

  # -------------------------------------------
  # BullMQ Dashboard (Optional - Dev Only)
  # -------------------------------------------
  bull-board:
    image: deadly0/bull-board
    container_name: rkj-bull-board
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - BULL_PREFIX=bull
    depends_on:
      - redis
    networks:
      - rkj-ai
    profiles:
      - dev

# -------------------------------------------
# Volumes
# -------------------------------------------
volumes:
  redis_data:
    driver: local
  recordings:
    driver: local
  temp_audio:
    driver: local
  temp_media:
    driver: local

# -------------------------------------------
# Networks
# -------------------------------------------
networks:
  rkj-ai:
    driver: bridge
    name: rkj-ai-network
